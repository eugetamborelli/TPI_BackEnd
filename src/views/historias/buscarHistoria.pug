doctype html
html
    head
        title Clínica Médica - Salud Integral
    body
        h1 Clínica Médica - Salud Integral
        h2 Gestión de Historias Clínicas
        br
        ul
            li
                a(href="/historias/buscarHistoria") Búsqueda de Historia Clínica
            li
                a(href="/historias/nuevaHistoria") Alta de nueva Historia Clínica
            li
                a(href="/historias") Volver al Menú de Gestión de Historias Clínicas
        br

        h3 Búsqueda de Historia Clínica

        if error
            p(style="color:red; font-weight:bold")= error
        
        if query && query.msg
            p(style="color:green; font-weight:bold")= query.msg

        //- Formulario de búsqueda por DNI
        form(method="GET", action="/historias/buscarHistoria")
            label(for="dni") Buscar paciente por DNI:
            input(type="text", name="dni", id="dni", value=dniBusqueda)
            button(type="submit") Buscar

        br
        hr

        if paciente
            h2 Datos del Paciente
            p
                strong Paciente: #{paciente.nombre} #{paciente.apellido}
            p DNI: #{paciente.dni}
            p Fecha de Nacimiento: #{formatDate ? formatDate(paciente.fechaNacimiento) : paciente.fechaNacimiento}

            if historia
                div(style="border: 1px solid #ccc; padding: 15px; margin-top: 20px;")
                    h2 Historia Clínica ##{historia.numeroHistoria || '-'}
                    p 
                        strong Fecha Creación: 
                        | #{formatDate ? formatDate(historia.fechaCreacion) : historia.fechaCreacion}
                    p 
                        strong Observaciones: 
                        | #{historia.observaciones}
                    
                    h3 Alergias
                    if historia.alergias && historia.alergias.length > 0
                        ul
                            each alergia in historia.alergias
                                li #{alergia}
                    else 
                        p No registra alergias.
                
                    h3 Medicamentos Actuales
                    if historia.medicamentosActuales && historia.medicamentosActuales.length > 0
                        ul
                            each med in historia.medicamentosActuales
                                li #{med.nombre} - #{med.dosis} - #{med.frecuencia}
                    else
                        p No registra medicamentos.
                
                    h3 Antecedentes
                    ul
                        if historia.antecedentes.familiares && historia.antecedentes.familiares.length > 0
                            li 
                                strong Familiares: 
                                | #{historia.antecedentes.familiares.join(", ")}
                        
                        if historia.antecedentes.personales && historia.antecedentes.personales.length > 0
                            li 
                                strong Personales: 
                                | #{historia.antecedentes.personales.join(", ")}
                        
                        if historia.antecedentes.quirurgicos && historia.antecedentes.quirurgicos.length > 0
                            li 
                                strong Quirúrgicos: 
                                | #{historia.antecedentes.quirurgicos.join(", ")}
                
                    br
                    div(style="display: flex; gap: 10px;")
                        a(href=`/historias/editar/${historia._id}`) 
                            button(type="button") Editar Historia Clínica

                        form(action=`/historias/eliminar/${historia._id}`, method="POST", onsubmit="return confirm('¿Está seguro de eliminar esta Historia Clínica? Esta acción no se puede deshacer.');")
                            button(type="submit") Eliminar Historia
                
            else
                //- Si el paciente existe pero no hay historia
                div(style="margin-top: 20px;")
                    h2 No hay Historia Clínica Registrada
                    p Para crear la historia clínica inicial, haga click aquí:
                    
                    a(href=`/historias/nuevaHistoria?dni=${paciente.dni}`)
                        button(type="button") Crear Historia Clínica